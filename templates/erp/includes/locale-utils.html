<script>
// Locale Utilities - Currency and Date Formatting with Real-time Conversion
// This script should be included in base.html to provide formatting across the entire site

(function() {
    // Currency exchange rates cache
    let exchangeRates = null;
    let lastFetchTime = null;
    const CACHE_DURATION = 3600000; // 1 hour in milliseconds
    let isInitialized = false;

    // Get user preferences from localStorage
    function getLocaleSettings() {
        const savedSettings = localStorage.getItem('languageSettings');
        if (savedSettings) {
            try {
                return JSON.parse(savedSettings);
            } catch (e) {
                console.error('Error parsing language settings:', e);
            }
        }
        // Default settings
        return {
            language: 'en',
            dateFormat: 'mdy',
            currency: 'USD',
            currencyFormat: 'symbol',
            decimalSeparator: 'dot',
            timezone: 'UTC',
            timeFormat: '12'
        };
    }

    // Currency symbols mapping
    const currencySymbols = {
        'USD': '$',
        'EUR': 'â‚¬',
        'GBP': 'Â£',
        'JPY': 'Â¥',
        'CNY': 'Â¥',
        'INR': 'â‚¹',
        'AUD': '$',
        'CAD': '$',
        'CHF': 'Fr',
        'PHP': 'â‚±'
    };

    // Fetch exchange rates from API
    async function fetchExchangeRates() {
        const now = Date.now();

        // Return cached rates if still valid
        if (exchangeRates && lastFetchTime && (now - lastFetchTime < CACHE_DURATION)) {
            return exchangeRates;
        }

        try {
            // Using exchangerate-api.com (free tier: 1500 requests/month)
            const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
            const data = await response.json();

            exchangeRates = data.rates;
            lastFetchTime = now;

            // Store in localStorage for offline use
            localStorage.setItem('exchangeRates', JSON.stringify({
                rates: exchangeRates,
                timestamp: lastFetchTime
            }));

            console.log('âœ… Currency exchange rates updated');
            return exchangeRates;
        } catch (error) {
            console.warn('âš ï¸ Failed to fetch exchange rates, using cached data:', error);

            // Try to use cached rates from localStorage
            const cached = localStorage.getItem('exchangeRates');
            if (cached) {
                const cachedData = JSON.parse(cached);
                exchangeRates = cachedData.rates;
                lastFetchTime = cachedData.timestamp;
                return exchangeRates;
            }

            // Fallback to default rates if nothing available
            return {
                'USD': 1,
                'EUR': 0.85,
                'GBP': 0.73,
                'JPY': 110.0,
                'CNY': 6.45,
                'INR': 74.5,
                'AUD': 1.35,
                'CAD': 1.25,
                'CHF': 0.92,
                'PHP': 50.0
            };
        }
    }

    // Convert currency amount
    async function convertCurrency(amount, fromCurrency, toCurrency) {
        if (fromCurrency === toCurrency) {
            return amount;
        }

        const rates = await fetchExchangeRates();

        // Convert from source currency to USD first
        const amountInUSD = amount / rates[fromCurrency];

        // Then convert from USD to target currency
        const convertedAmount = amountInUSD * rates[toCurrency];

        return convertedAmount;
    }

    // Format currency based on user settings with conversion
    window.formatCurrency = async function(amount, options = {}) {
        const settings = getLocaleSettings();
        const targetCurrency = options.currency || settings.currency;
        const format = options.format || settings.currencyFormat;
        const separator = settings.decimalSeparator;
        const sourceCurrency = options.sourceCurrency || 'USD'; // Assume USD if not specified

        // Parse amount to number
        let numAmount = typeof amount === 'string' ? parseFloat(amount.replace(/[^0-9.-]/g, '')) : amount;

        if (isNaN(numAmount)) return amount;

        // Convert currency if needed
        if (sourceCurrency !== targetCurrency) {
            numAmount = await convertCurrency(numAmount, sourceCurrency, targetCurrency);
        }

        // Format number based on decimal separator
        let formattedNumber;
        if (separator === 'comma') {
            formattedNumber = numAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, '.').replace(/\.(\d{2})$/, ',$1');
        } else if (separator === 'space') {
            formattedNumber = numAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ').replace(/\.(\d{2})$/, ',$1');
        } else { // dot (default)
            formattedNumber = numAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        const symbol = currencySymbols[targetCurrency] || '$';

        // Format based on display preference
        switch (format) {
            case 'code':
                return `${targetCurrency} ${formattedNumber}`;
            case 'both':
                return `${symbol}${formattedNumber} ${targetCurrency}`;
            case 'symbol':
            default:
                return `${symbol}${formattedNumber}`;
        }
    };

    // Format date based on user settings
    window.formatDate = function(dateString, options = {}) {
        const settings = getLocaleSettings();
        const format = options.format || settings.dateFormat;
        const includeTime = options.includeTime || false;
        const timeFormat = settings.timeFormat;

        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;

        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();

        let dateFormatted;
        switch (format) {
            case 'dmy':
                dateFormatted = `${day}/${month}/${year}`;
                break;
            case 'ymd':
                dateFormatted = `${year}-${month}-${day}`;
                break;
            case 'mdy':
            default:
                dateFormatted = `${month}/${day}/${year}`;
                break;
        }

        if (includeTime) {
            let hours = date.getHours();
            const minutes = String(date.getMinutes()).padStart(2, '0');

            if (timeFormat === '12') {
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12 || 12;
                dateFormatted += ` ${hours}:${minutes} ${ampm}`;
            } else {
                dateFormatted += ` ${String(hours).padStart(2, '0')}:${minutes}`;
            }
        }

        return dateFormatted;
    };

    // Apply currency formatting to all elements with data-currency attribute
    async function applyCurrencyFormatting() {
        if (isInitialized) {
            console.log('ðŸ”„ Refreshing currency display...');
        }

        const elements = document.querySelectorAll('[data-currency]');

        if (elements.length === 0) {
            console.log('â„¹ï¸ No currency elements found on this page');
            return;
        }

        for (const element of elements) {
            const amount = element.getAttribute('data-currency');
            const sourceCurrency = element.getAttribute('data-source-currency') || 'USD';

            try {
                const formatted = await formatCurrency(amount, { sourceCurrency });
                element.textContent = formatted;
            } catch (error) {
                console.error('Error formatting currency:', error);
            }
        }

        isInitialized = true;
        console.log(`âœ… Formatted ${elements.length} currency elements`);
    }

    // Apply date formatting to all elements with data-date attribute
    function applyDateFormatting() {
        document.querySelectorAll('[data-date]').forEach(element => {
            const dateStr = element.getAttribute('data-date');
            const includeTime = element.hasAttribute('data-include-time');
            element.textContent = formatDate(dateStr, { includeTime });
        });
    }

    // Initialize formatting on page load
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('ðŸš€ Initializing locale utilities...');

        // Fetch exchange rates on page load (in background)
        fetchExchangeRates().then(() => {
            console.log('ðŸ’± Exchange rates loaded successfully');
        }).catch(err => {
            console.error('âŒ Failed to load exchange rates:', err);
        });

        // Apply formatting
        try {
            await applyCurrencyFormatting();
            applyDateFormatting();
            console.log('âœ… Locale formatting initialized');
        } catch (error) {
            console.error('âŒ Error initializing locale formatting:', error);
        }
    });

    // Refresh currency display when settings change
    window.addEventListener('storage', function(e) {
        if (e.key === 'languageSettings') {
            console.log('ðŸ”„ Language settings changed, updating display...');
            setTimeout(() => {
                applyCurrencyFormatting();
                applyDateFormatting();
            }, 100);
        }
    });

    // Expose functions globally for manual refresh
    window.getLocaleSettings = getLocaleSettings;
    window.convertCurrency = convertCurrency;
    window.refreshCurrencyDisplay = applyCurrencyFormatting;
    window.refreshDateDisplay = applyDateFormatting;
})();
</script>
