{% extends 'erp/base.html' %}


{% block title %}Settings - LiteWork{% endblock %}
{% block page_title %}<span data-translate="Settings">Settings</span>{% endblock %}

{% block content %}
<div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md min-h-full flex flex-col">
    <div class="flex border-b border-gray-200 dark:border-gray-700 text-lg mb-6 space-x-2">
        <span class="font-semibold bg-blue-600 dark:bg-blue-700 text-white px-4 py-2 rounded-t-lg cursor-pointer tab-button tab-active" data-tab="account" data-translate="Account & Security">Account & Security</span>
        <span class="font-semibold bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-t-lg cursor-pointer tab-button" data-tab="language" data-translate="Language & Currency">Language & Currency</span>
    </div>

    <div id="account-tab" class="tab-content flex-1">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white" data-translate="Account Information">Account Information</h2>

            <div class="flex justify-between items-center account-info-line">
                <span class="font-medium w-1/3 text-gray-900 dark:text-white" data-translate="Username">Username</span>
                <span class="text-lg w-1/3 text-left text-gray-900 dark:text-white">{{ user.get_full_name|default:user.username }}</span>
                <div class="relative w-1/3 text-right">
                    <button onclick="toggleEditForm('username-form')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-1 rounded-md text-sm flex items-center justify-end ml-auto">
                        <span data-translate="Edit">Edit</span> <i class="fas fa-caret-down ml-2"></i>
                    </button>
                    <div id="username-form" class="hidden mt-2 bg-white dark:bg-gray-800 p-3 rounded-md shadow-lg absolute right-0 z-10 w-64 border border-gray-200 dark:border-gray-600">
                        <form method="post" action="{% url 'erp:update_profile' %}">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="username">
                            <input type="text" name="full_name" placeholder="Full Name" class="w-full mb-2 p-2 text-gray-800 bg-gray-100 dark:bg-gray-700 dark:text-white rounded border border-gray-300 dark:border-gray-600">
                            <button type="submit" class="bg-green-600 text-white px-3 py-1 rounded w-full hover:bg-green-700" data-translate="Save">Save</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center account-info-line">
                <span class="font-medium w-1/3 text-gray-900 dark:text-white" data-translate="Email">Email</span>
                <span class="text-lg w-1/3 text-left text-gray-900 dark:text-white">{{ user.email }}</span>
                <div class="relative w-1/3 text-right">
                    <button onclick="toggleEditForm('email-form')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-1 rounded-md text-sm flex items-center justify-end ml-auto">
                        <span data-translate="Edit">Edit</span> <i class="fas fa-caret-down ml-2"></i>
                    </button>
                    <div id="email-form" class="hidden mt-2 bg-white dark:bg-gray-800 p-3 rounded-md shadow-lg absolute right-0 z-10 w-64 border border-gray-200 dark:border-gray-600">
                        <form method="post" action="{% url 'erp:update_profile' %}">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="email">
                            <input type="email" name="email" placeholder="Email" class="w-full mb-2 p-2 text-gray-800 bg-gray-100 dark:bg-gray-700 dark:text-white rounded border border-gray-300 dark:border-gray-600">
                            <button type="submit" class="bg-green-600 text-white px-3 py-1 rounded w-full hover:bg-green-700" data-translate="Save">Save</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center account-info-line border-b-0">
                <span class="font-medium w-1/3 text-gray-900 dark:text-white" data-translate="Password">Password</span>
                <span class="text-lg w-1/3 text-left text-gray-600 dark:text-gray-400" data-translate="Update your password">Update your password</span>
                <div class="relative w-1/3 text-right">
                    <button onclick="toggleEditForm('password-form')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-1 rounded-md text-sm flex items-center justify-end ml-auto">
                        <span data-translate="Update">Update</span> <i class="fas fa-caret-down ml-2"></i>
                    </button>
                    <div id="password-form" class="hidden mt-2 bg-white dark:bg-gray-800 p-3 rounded-md shadow-lg absolute right-0 z-10 w-64 border border-gray-200 dark:border-gray-600">
                        <form method="post" action="{% url 'erp:update_profile' %}">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="password">
                            <input type="password" name="current_password" placeholder="Current Password" class="w-full mb-2 p-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white rounded border border-gray-300 dark:border-gray-600">
                            <input type="password" name="new_password" placeholder="New Password" class="w-full mb-2 p-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white rounded border border-gray-300 dark:border-gray-600">
                            <input type="password" name="confirm_password" placeholder="Confirm Password" class="w-full mb-2 p-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white rounded border border-gray-300 dark:border-gray-600">
                            <button type="submit" class="bg-green-600 text-white px-3 py-1 rounded w-full hover:bg-green-700" data-translate="Save">Save</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 mb-6">
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white" data-translate="Account Protection">Account Protection</h2>

            <div class="flex justify-between items-center">
                <div>
                    <h3 class="font-semibold text-lg mb-1 text-gray-900 dark:text-white" data-translate="2-step Verification">2-step Verification</h3>
                    <p class="text-sm text-gray-700 dark:text-gray-300" data-translate="Enable 2-step verification to send security code to the email and phone number provided above whenever logging in.">Enable 2-step verification to send security code to the email and phone number provided above whenever logging in.</p>
                </div>
                <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="toggle" id="toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                    <label for="toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-gray-600 cursor-pointer"></label>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 mb-6">
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white" data-translate="Application Settings">Application Settings</h2>
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="font-semibold text-lg mb-1 text-gray-900 dark:text-white" data-translate="Dark Mode">Dark Mode</h3>
                    <p class="text-sm text-gray-700 dark:text-gray-300" data-translate="Toggle between light and dark mode for better viewing experience.">Toggle between light and dark mode for better viewing experience.</p>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="darkModeToggle" class="toggle-checkbox" />
                </div>
            </div>
        </div>

        <!-- Logout Button -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="font-semibold text-lg mb-1 text-gray-900 dark:text-white" data-translate="Logout">Logout</h3>
                    <p class="text-sm text-gray-700 dark:text-gray-300" data-translate="Sign out from your current session">Sign out from your current session</p>
                </div>
                <a href="{% url 'logout' %}" class="bg-red-600 text-white px-6 py-2 rounded-md hover:bg-red-700 transition-colors">
                    <span data-translate="Logout">Logout</span> <i class="fas fa-sign-out-alt ml-2"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Language & Currency Tab -->
    <div id="language-tab" class="tab-content flex-1 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 mb-6">
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white" data-translate="Language Preferences">Language Preferences</h2>

            <div class="flex justify-between items-center mb-6">
                <div class="flex-1">
                    <h3 class="font-semibold text-lg mb-1 text-gray-900 dark:text-white" data-translate="Display Language">Display Language</h3>
                    <p class="text-sm text-gray-700 dark:text-gray-300" data-translate="Choose your preferred language for the application interface">Choose your preferred language for the application interface</p>
                </div>
                <div class="w-64">
                    <select id="languageSelect" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="zh">Chinese</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                        <option value="ar">Arabic</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <h3 class="font-semibold text-lg mb-1 text-gray-900 dark:text-white" data-translate="Date Format">Date Format</h3>
                    <p class="text-sm text-gray-700 dark:text-gray-300" data-translate="Choose how dates are displayed throughout the system">Choose how dates are displayed throughout the system</p>
                </div>
                <div class="w-64">
                    <select id="dateFormatSelect" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="mdy">MM/DD/YYYY (US)</option>
                        <option value="dmy">DD/MM/YYYY (Europe)</option>
                        <option value="ymd">YYYY-MM-DD (ISO)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 mb-6">
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white" data-translate="Currency Settings">Currency Settings</h2>

            <div class="flex justify-between items-center mb-6">
                <div class="flex-1">
                    <h3 class="font-semibold text-lg mb-1 text-gray-900 dark:text-white" data-translate="Default Currency">Default Currency</h3>
                    <p class="text-sm text-gray-700 dark:text-gray-300" data-translate="Set the primary currency for transactions and reports">Set the primary currency for transactions and reports</p>
                </div>
                <div class="w-64">
                    <select id="currencySelect" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="USD">USD - US Dollar ($)</option>
                        <option value="EUR">EUR - Euro (€)</option>
                        <option value="GBP">GBP - British Pound (£)</option>
                        <option value="JPY">JPY - Japanese Yen (¥)</option>
                        <option value="CNY">CNY - Chinese Yuan (¥)</option>
                        <option value="INR">INR - Indian Rupee (₹)</option>
                        <option value="AUD">AUD - Australian Dollar ($)</option>
                        <option value="CAD">CAD - Canadian Dollar ($)</option>
                        <option value="CHF">CHF - Swiss Franc (Fr)</option>
                        <option value="PHP">PHP - Philippine Peso (₱)</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-between items-center mb-6">
                <div class="flex-1">
                    <h3 class="font-semibold text-lg mb-1 text-gray-900 dark:text-white" data-translate="Currency Display">Currency Display</h3>
                    <p class="text-sm text-gray-700 dark:text-gray-300" data-translate="Choose how currency amounts are formatted">Choose how currency amounts are formatted</p>
                </div>
                <div class="w-64">
                    <select id="currencyFormatSelect" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="symbol">Symbol ($1,234.56)</option>
                        <option value="code">Code (USD 1,234.56)</option>
                        <option value="both">Both ($1,234.56 USD)</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <h3 class="font-semibold text-lg mb-1 text-gray-900 dark:text-white" data-translate="Decimal Separator">Decimal Separator</h3>
                    <p class="text-sm text-gray-700 dark:text-gray-300" data-translate="Choose decimal and thousand separators">Choose decimal and thousand separators</p>
                </div>
                <div class="w-64">
                    <select id="decimalSeparatorSelect" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="dot">1,234.56 (Dot)</option>
                        <option value="comma">1.234,56 (Comma)</option>
                        <option value="space">1 234,56 (Space)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 mb-6">
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white" data-translate="Regional Settings">Regional Settings</h2>

            <div class="flex justify-between items-center mb-6">
                <div class="flex-1">
                    <h3 class="font-semibold text-lg mb-1 text-gray-900 dark:text-white" data-translate="Time Zone">Time Zone</h3>
                    <p class="text-sm text-gray-700 dark:text-gray-300" data-translate="Set your local time zone for accurate timestamps">Set your local time zone for accurate timestamps</p>
                </div>
                <div class="w-64">
                    <select id="timezoneSelect" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="UTC">UTC (GMT+0:00)</option>
                        <option value="America/New_York">Eastern Time (GMT-5:00)</option>
                        <option value="America/Chicago">Central Time (GMT-6:00)</option>
                        <option value="America/Denver">Mountain Time (GMT-7:00)</option>
                        <option value="America/Los_Angeles">Pacific Time (GMT-8:00)</option>
                        <option value="Europe/London">London (GMT+0:00)</option>
                        <option value="Europe/Paris">Paris (GMT+1:00)</option>
                        <option value="Asia/Tokyo">Tokyo (GMT+9:00)</option>
                        <option value="Asia/Shanghai">Shanghai (GMT+8:00)</option>
                        <option value="Asia/Manila">Manila (GMT+8:00)</option>
                        <option value="Australia/Sydney">Sydney (GMT+10:00)</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <h3 class="font-semibold text-lg mb-1 text-gray-900 dark:text-white" data-translate="Time Format">Time Format</h3>
                    <p class="text-sm text-gray-700 dark:text-gray-300" data-translate="Choose between 12-hour and 24-hour time format">Choose between 12-hour and 24-hour time format</p>
                </div>
                <div class="w-64">
                    <select id="timeFormatSelect" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="12">12-hour (2:30 PM)</option>
                        <option value="24">24-hour (14:30)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="flex justify-end">
            <button id="saveLanguageSettings" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors font-semibold">
                <i class="fas fa-save mr-2"></i><span data-translate="Save Changes">Save Changes</span>
            </button>
        </div>
    </div>
</div>

<style>
    .account-info-line {
        padding: 1rem 0;
        border-bottom: 1px solid #e5e7eb;
    }

    html.dark .account-info-line {
        border-bottom: 1px solid #374151;
    }

    .toggle-checkbox:checked {
        right: 0;
        border-color: #68D391;
    }

    .toggle-checkbox:checked + .toggle-label {
        background-color: #68D391;
    }

    /* Tab button styling - fix to prevent both tabs from being blue */
    .tab-button {
        transition: all 0.3s ease;
        background-color: #e5e7eb; /* gray-200 */
        color: #374151; /* gray-700 */
    }

    html.dark .tab-button {
        background-color: #374151; /* gray-700 in dark mode */
        color: #d1d5db; /* gray-300 in dark mode */
    }

    .tab-button:hover:not(.tab-active) {
        background-color: #d1d5db; /* gray-300 */
        color: #1f2937;
    }

    html.dark .tab-button:hover:not(.tab-active) {
        background-color: #4b5563; /* gray-600 */
        color: #f3f4f6;
    }

    .tab-button.tab-active {
        background-color: #2563eb !important; /* blue-600 */
        color: white !important;
    }

    html.dark .tab-button.tab-active {
        background-color: #1d4ed8 !important; /* blue-700 in dark mode */
        color: white !important;
    }
</style>

<script>
    // Dark mode toggle logic
    const darkModeToggle = document.getElementById('darkModeToggle');

    // Check localStorage for dark mode preference and set toggle
    if (localStorage.getItem('darkMode') === 'enabled') {
        document.documentElement.classList.add('dark');
        darkModeToggle.checked = true;
    }

    // Handle dark mode toggle
    darkModeToggle.addEventListener('change', function() {
        if (this.checked) {
            document.documentElement.classList.add('dark');
            localStorage.setItem('darkMode', 'enabled');
        } else {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('darkMode', 'disabled');
        }
    });

    // Toggle form visibility
    function toggleEditForm(formId) {
        const form = document.getElementById(formId);
        const allForms = document.querySelectorAll('[id$="-form"]');

        // Hide all forms first
        allForms.forEach(f => {
            if (f.id !== formId) {
                f.classList.add('hidden');
            }
        });

        // Toggle the selected form
        form.classList.toggle('hidden');
    }

    // 2-step verification toggle
    document.getElementById('toggle').addEventListener('change', function() {
        const isEnabled = this.checked;
        console.log('2-step verification ' + (isEnabled ? 'enabled' : 'disabled'));
    });

    // Tab switching logic
    document.addEventListener('DOMContentLoaded', function() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // Check if we should open a specific tab (e.g., after settings save)
        const activeTab = localStorage.getItem('activeSettingsTab') || 'account';

        // Hide all tabs first
        tabContents.forEach(content => content.classList.add('hidden'));
        tabButtons.forEach(btn => btn.classList.remove('tab-active'));

        // Show the active tab
        const activeButton = document.querySelector(`[data-tab="${activeTab}"]`);
        const activeContent = document.getElementById(activeTab + '-tab');

        if (activeButton && activeContent) {
            activeButton.classList.add('tab-active');
            activeContent.classList.remove('hidden');
        }

        // Clear the flag after opening the tab
        localStorage.removeItem('activeSettingsTab');

        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');

                // Remove active class from all buttons and hide all contents
                tabButtons.forEach(btn => btn.classList.remove('tab-active'));
                tabContents.forEach(content => content.classList.add('hidden'));

                // Add active class to clicked button and show corresponding content
                this.classList.add('tab-active');
                document.getElementById(tabName + '-tab').classList.remove('hidden');
            });
        });

        // Load saved language and currency preferences
        loadLanguageSettings();

        // Save language settings
        const saveButton = document.getElementById('saveLanguageSettings');
        if (saveButton) {
            saveButton.addEventListener('click', function() {
                const settings = {
                    language: document.getElementById('languageSelect').value,
                    dateFormat: document.getElementById('dateFormatSelect').value,
                    currency: document.getElementById('currencySelect').value,
                    currencyFormat: document.getElementById('currencyFormatSelect').value,
                    decimalSeparator: document.getElementById('decimalSeparatorSelect').value,
                    timezone: document.getElementById('timezoneSelect').value,
                    timeFormat: document.getElementById('timeFormatSelect').value
                };

                localStorage.setItem('languageSettings', JSON.stringify(settings));

                // Remember to open Language & Currency tab after refresh
                localStorage.setItem('activeSettingsTab', 'language');

                // Apply translations immediately
                if (typeof applyTranslations === 'function') {
                    applyTranslations();
                }

                // Refresh currency display if currency changed
                if (typeof refreshCurrencyDisplay === 'function') {
                    refreshCurrencyDisplay();
                }

                // Show success message and auto-refresh
                alert('Settings saved successfully!');

                // Auto-refresh the page to apply all changes
                setTimeout(() => {
                    location.reload();
                }, 500);
            });
        }
    });

    function loadLanguageSettings() {
        const savedSettings = localStorage.getItem('languageSettings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            const languageSelect = document.getElementById('languageSelect');
            if (languageSelect) {
                languageSelect.value = settings.language || 'en';
                document.getElementById('dateFormatSelect').value = settings.dateFormat || 'mdy';
                document.getElementById('currencySelect').value = settings.currency || 'USD';
                document.getElementById('currencyFormatSelect').value = settings.currencyFormat || 'symbol';
                document.getElementById('decimalSeparatorSelect').value = settings.decimalSeparator || 'dot';
                document.getElementById('timezoneSelect').value = settings.timezone || 'UTC';
                document.getElementById('timeFormatSelect').value = settings.timeFormat || '12';
            }
        }
    }
</script>
{% endblock %}
